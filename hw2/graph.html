<!DOCTYPE html>
<html lang="en">
<meta charset="utf-8">
<head>
  <style>

  .link {
    stroke: gray;
    stroke-width: .8px;
  }

  .node {
    fill: white;
    stroke: #000;
    stroke-width: .9px;
  }

  .node:hover {
    fill: black;
  }
  .text{
	fill: black;
	stroke-width: 0px;
  font-size: .9em;
  }
  </style>
</head>
<body>
 <table>
    <tr>
      <td>Layout:</td>
      <td><label><input type="radio" name="layout" value="force" checked> Force</label>
      </td>
    </tr>
    <tr>
      <td></td>
      <td style="text-align: right;">&#9658;</td>
      <td>Rankings:</td>
      <td><label><input type="radio" name="ranking" value="norank" checked> none</label>
      </td>
      <td><label><input type="radio" name="ranking" value="rank" >Rankings</label>
        &nbsp;&nbsp;&nbsp;
      </td>
      <td>Key:<select id="selectKeys" onchange="keyChanged(this);">
      <option value="gdp" selected="selected">GDP</option>
      <option value="population" >Population</option>
      <option value="life_expectancy" >Life_expectancy</option>
      </select>
      </td>
    </tr>
    <tr>
      <td></td>
      <td style="text-align: right;">&#9658;</td>
      <td>Scatterplot:</td>
      <td><label><input type="radio" name="ranking" value="growth"> Population/GDP</label>
      </td>
      <td><label><input type="radio" name="ranking" value="location" >longitude/latitude</label>
      </td>
    </tr>
    <tr>
      <td></td>
      <td><label><input type="radio" name="layout" value="circular"> Circular</label> 
      </td>
    </tr>
    <tr>
      <td></td>
      <td style="text-align: right;">&#9658;</td>
      <td>Sortkey:</td>
      <td><label><input type="radio" name="circle" value="gdp" checked> GDP</label>
      </td>
      <td><label><input type="radio" name="circle" value="pop" >Population</label>
    </tr>
 </table>


<!-- 		<form>
		Color:
		<label><input type="radio" name="color" value="nocolor" checked> None</label>
		<label><input type="radio" name="color" value="color_cat" > Category</label>
		</form>
		<form>
		Size:
		<label><input type="radio" name="size" value="nosize" checked> None</label>
		<label><input type="radio" name="size" value="size_cat" > Category</label> -->
    <script src="d3.min.js"></script>
    <script>

  var sorting = ""; //status of sorting 'asc' or 'desc'
  var lastSelectedCol = ""; //selected column for sorting last time 
  var dataset = []; //mapped data
  var dyear = []; //tmp variable for min/max year
  var selectedYear = ""; //hold selected year in range
  var selDataset = []; //filtered data by year
  var aggr_on = ""; //status of aggrigation
  var selConti = []; //selection of continents among filter checkbox
  var selKey = "gdp"; //rank key default 

    //initialize barchart(Gloval)
	var margin = {top: 5, bottom: 5, left: 10, right: 10};
	var width = 1500 - margin.left - margin.right;
	var height = 1500 - margin.top - margin.bottom;

	var svg = d3.select("body").append("svg")
	            .attr("width", width)
	            .attr("height", height);

	var fill = d3.scale.category10();

	var graph = {nodes: [], links: []};

  var nameScale = d3.scale.ordinal().rangeRoundBands([0, height], .8, 0);

	var xScale = d3.scale.linear();
  var yScale = d3.scale.linear();
  var xScale_loc = d3.scale.linear();
  var yScale_loc = d3.scale.linear();

	var nb_nodes = 100, nb_cat = 1;

	var node_scale = d3.scale.linear();

	//SETTING GRAPH.NODES
	graph.nodes = d3.range(120).map(function() {  
	  return { 
	    cat: nb_cat
	  }; 
	})

	// Generate the force layout
	var force = d3.layout.force()
	    .size([width, height])
	    //.charge(-10) //between nodes, so they will repel each other more
	    //.linkDistance(10) //the length of the edges between connected nodes
	    .on("tick", tick)
	    .on("start", function(d) {}) //animation
	    .on("end", function(d) {}) //animation

 	var node = svg.selectAll(".node")
            .data(graph.nodes)
            .enter()
            .append("g").attr("class", "node");

	node.append("circle")
	    .attr("r", 5);

	node.append("text")
		.attr("x", 10)
		.attr("y", 4)
		.attr("class","text")
		.text("test");



    //DATA LOAD
    d3.json("data/countries_1995_2012.json", function(error, data){

		//mapping
		data.map(function(d,i){
		    for (i = 0; i < d.years.length; i++) {
		        var dat = {
		          name: d.name,
		          continent: d.continent,
		          gdp: d.years[i].gdp,
		          life_expectancy: d.years[i]["Life expectancy at birth, total (years)"],
		          population: d.years[i].population,
		          year: d.years[i].year,
              latitude: d.latitude,
              longitude: d.longitude
		        };

		        dataset.push(dat);

		        //for year min and max
		        dyear.push(d.years[i].year);
		    }
		});

		rangechanged("2012");

    force.nodes(graph.nodes)
          //.links(graph.links)
    .start();

    sortingdata(selDataset,"gdp");
		graph_update_norank();

	}); //End json loading

	function tick(d) {
	  graph_update(100);
	}

  function sortingdata(vdataset,keyval){
      selDataset = selDataset.sort(function(a, b) {
              return d3.descending(a[keyval], b[keyval]);
      });

  }

	function graph_update(duration) {

	  node.transition().duration(duration)
	      .attr("transform", function(d) { 
	        return "translate("+d.x+","+d.y+")"; 
	      })
	      .attr("id",function(d){
	      	return d.cat;
	      })
	      .select("text")
	      .text(function(d){ return d.cat});
		  
	}

  function graph_update_norank() { //(1)

    force.stop();

    //scale-----
    nameScale.domain(selDataset.map(function(d) {
         return d.name;
    }));

    graph.nodes.forEach(function(d, i) {
      d.x = width/3;
      d.y = nameScale(selDataset[i].name);
      d.cat = selDataset[i].name;
      d.pop = selDataset[i].population;
      d.gdp = selDataset[i].gdp;
    })

    graph_update(500);
  }

	function graph_update_rank() { //(2)

	  force.stop();

    var min = 0;
    if(selKey == "life_expectancy"){
        min = selDataset[selDataset.length-1][selKey];
    }

    node_scale
        .domain([min, selDataset[0][selKey]])
        .range([5, height-10]);

	  graph.nodes.forEach(function(d, i) {
      d.x = width/3;
	    d.y = height - node_scale(selDataset[i][selKey]);
      d.cat = selDataset[i].name;
	  })

	  graph_update(500);
	}

	function graph_update_growth() { //(3)

	  force.stop();

      xScale
        .domain([0,d3.max(selDataset.map(function(d) { return d.gdp; }))])
        .range([5, height-100]);
      yScale
        .domain([0,d3.max(selDataset.map(function(d) { return d.population; }))])
        .range([5, width-50]);

	  graph.nodes.forEach(function(d, i) {
	    // d.x = height - xScale(selDataset[i].gdp);
     //  d.y = yScale(selDataset[i].population);
      d.x = xScale(selDataset[i].gdp);
      d.y = height - yScale(selDataset[i].population);
      d.cat = selDataset[i].name;
	  })

	  graph_update(500);
	}

	function graph_update_location() { //(4)

    force.stop();

      xScale_loc
        .domain([-180,180])
        .range([0, width-20]);
      yScale_loc
        .domain([-180,180])
        .range([0, height]);

    graph.nodes.forEach(function(d, i) {
      d.x = xScale_loc(selDataset[i].longitude) -200;
      d.y = height - yScale_loc(selDataset[i].latitude);
      d.cat = selDataset[i].name;
    })
	  graph_update(500);
	}

  function keyChanged(selVal){
      
      selKey = selVal.value //save to gloval
      var selGraph = "";
      
      sortingdata(selDataset,selKey); //sort

      d3.selectAll("input").each(function(d) {
          if(d3.select(this).attr("name") == "ranking" && d3.select(this).node().checked) {
              selGraph = d3.select(this).attr("value");
          }
      });

      switch(selGraph){
        case("norank"):
            graph_update_norank();
            console.log("norank!");
            break;
        case("rank"):
            graph_update_rank();
            console.log("rank!");
            break;
        case("growth"):
            //nothing
            break;
        case("location"):
            //nothing
            break;
      };
  }

  function circular_layout(){

      force.stop();

      //get sortkey
      var sortkey_circle    
      d3.selectAll("input").each(function(d) {
          if(d3.select(this).attr("name") == "circle" && d3.select(this).node().checked) {
              sortkey_circle = d3.select(this).attr("value");
          }
      });

      var r = Math.min(height, width)/2;

      var arc = d3.svg.arc()
              .outerRadius(r);

      var pie = d3.layout.pie()
            switch(sortkey_circle){
                case "gdp":
                    pie.sort(function(a, b) { return a.gdp - b.gdp;}) // Sorting by categories
                    break;
                case "pop":
                    pie.sort(function(a, b) { return a.pop - b.pop;}) // Sorting by categories
                    break;
            }
            pie.value(function(d, i) { 
                return 1;  // We want an equal pie share/slice for each point
            });

      graph.nodes = pie(graph.nodes).map(function(d, i) {
        // Needed to caclulate the centroid
        d.innerRadius = 0;
        d.outerRadius = r;

        // Building the data object we are going to return
        d.data.x = arc.centroid(d)[0]+width/2;
        d.data.y = arc.centroid(d)[1]+height/2;

        return d.data;
      })

      graph_update(500);


  }

  function force_layout(){




  }

	d3.select("input[value=\"rank\"]").on("click", graph_update_rank);
	d3.select("input[value=\"norank\"]").on("click", graph_update_norank);
	d3.select("input[value=\"growth\"]").on("click", graph_update_growth);
	d3.select("input[value=\"location\"]").on("click", graph_update_location);
  d3.select("input[value=\"force\"]").on("click", force_layout);
  d3.select("input[value=\"circular\"]").on("click", circular_layout);

	// d3.select("input[value=\"force\"]").on("click", force_layout);
	// d3.select("input[value=\"random\"]").on("click", random_layout);
	// d3.select("input[value=\"line\"]").on("click", line_layout);
	// d3.select("input[value=\"line_cat\"]").on("click", line_cat_layout);
	// d3.select("input[value=\"circular\"]").on("click", circular_layout);

	// d3.select("input[value=\"nocolor\"]").on("click", function() {
	//   d3.selectAll("circle").transition().duration(500).style("fill", "#66CC66");
	// })

	// d3.select("input[value=\"color_cat\"]").on("click", category_color);

	// d3.select("input[value=\"nosize\"]").on("click", function() {
	//   d3.selectAll("circle").transition().duration(500).attr("r", 5);
	// })

	// d3.select("input[value=\"size_cat\"]").on("click", category_size);

	// var link = svg.selectAll(".link")
	//               .data(graph.links);

	// link.enter().append("line")
	//     .attr("class", "link")


    //Range
    function rangechanged(newVal){

        var indexed_data = []
        var tmpdata = []

        //preserve in Global
        selectedYear = newVal;

        dataset.map(function(d,i){
            if (d.year == newVal){
                tmpdata.push(d);  
            }
            indexed_data[newVal] = tmpdata
        });

        //preserve in Global
        selDataset = indexed_data[newVal];
        
        //check aggrigation, filter etc
        //distributeFunc();
    };


    </script> 
  </body>
</html>